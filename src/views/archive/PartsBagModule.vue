<template>
  <div class="parts-bag-module">
    <el-card class="module-card">
      <template #header>
        <div class="card-header">
          <el-icon class="header-icon"><Box /></el-icon>
          <div>
            <h2>Èõ∂‰ª∂ËÉåÂåÖ</h2>
            <p class="module-desc">Èõ∂‰ª∂Áâ©ÂìÅÁÆ°ÁêÜÂíåÊü•Áúã</p>
          </div>
        </div>
      </template>
      
      <!-- ËÉåÂåÖÁªüËÆ°‰ø°ÊÅØ -->
      <div class="bag-stats">
        <el-row :gutter="20">
          <el-col :span="8">
            <el-card class="stat-card" shadow="hover">
              <div class="stat-content">
                <div class="stat-icon">
                  <el-icon class="text-primary"><Box /></el-icon>
                </div>
                <div class="stat-info">
                  <div class="stat-label">ÊÄªÁâ©ÂìÅÊï∞</div>
                  <div class="stat-value text-primary">{{ totalItems }}</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card class="stat-card" shadow="hover">
              <div class="stat-content">
                <div class="stat-icon">
                  <el-icon class="text-success"><Grid /></el-icon>
                </div>
                <div class="stat-info">
                  <div class="stat-label">ËÉåÂåÖÂÆπÈáè</div>
                  <div class="stat-value text-success">{{ gripMaxNum }}</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card class="stat-card" shadow="hover">
              <div class="stat-content">
                <div class="stat-icon">
                  <el-icon class="text-warning"><Collection /></el-icon>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Â∑≤‰ΩøÁî®</div>
                  <div class="stat-value text-warning">{{ usedSlots }}</div>
                </div>
              </div>
            </el-card>
          </el-col>
        </el-row>
      </div>
      
      <!-- Áâ©ÂìÅÁΩëÊ†º -->
      <div class="items-section">
        <el-divider content-position="left">
          <el-icon><Grid /></el-icon>
          <span>Áâ©ÂìÅÂàóË°®</span>
        </el-divider>
        
        <!-- Á≠õÈÄâÂíåÊêúÁ¥¢ -->
        <div class="filter-section">
          <el-row :gutter="20" class="mb-20">
            <el-col :span="6">
              <el-input
                v-model="searchText"
                placeholder="ÊêúÁ¥¢Áâ©ÂìÅÂêçÁß∞"
                clearable
                @input="handleSearch"
              >
                <template #prefix>
                  <el-icon><Search /></el-icon>
                </template>
              </el-input>
            </el-col>
            <el-col :span="4">
              <el-select v-model="selectedColor" placeholder="ÈÄâÊã©ÂìÅË¥®" clearable @change="handleFilter">
                <el-option label="ÂÖ®ÈÉ®" value="" />
              </el-select>
            </el-col>
            <el-col :span="4">
              <el-select v-model="selectedType" placeholder="ÈÄâÊã©Á±ªÂûã" clearable @change="handleFilter">
                <el-option label="ÂÖ®ÈÉ®" value="" />
                <el-option label="ÊôÆÈÄöÈõ∂Èõ∂‰ª∂" value="loaderParts" />
                <el-option label="ÈùûÊôÆÈÄöÈõ∂Èõ∂‰ª∂" value="UniqueParts" />
              </el-select>
            </el-col>
            <el-col :span="6">
              <el-select v-model="sortBy" placeholder="ÊéíÂ∫èÊñπÂºè" @change="handleSort">
                <el-option label="ÈªòËÆ§" value="default" />
                <el-option label="Á≠âÁ∫ßÈôçÂ∫è" value="level-desc" />
                <el-option label="Á≠âÁ∫ßÂçáÂ∫è" value="level-asc" />
                <el-option label="Êï∞ÈáèÈôçÂ∫è" value="quantity-desc" />
                <el-option label="Êï∞ÈáèÂçáÂ∫è" value="quantity-asc" />
                <el-option label="ÂìÅË¥®ÊéíÂ∫è" value="color" />
                <el-option label="Á±ªÂûãÊéíÂ∫è" value="type" />
              </el-select>
            </el-col>
            <el-col :span="4">
              <el-button @click="resetFilters" type="primary" plain>
                <el-icon><Refresh /></el-icon>
                ÈáçÁΩÆ
              </el-button>
            </el-col>
          </el-row>
        </div>
        
        <!-- Áâ©ÂìÅÁΩëÊ†º -->
        <div class="items-grid">
          <div 
            v-for="item in paginatedItems" 
            :key="item.id"
            class="item-slot"
            :class="{ 'new-item': item.newB, 'locked': item.lockB }"
          >
            <!-- Áâ©ÂìÅÂõæÁâáÂíåËÉåÊôØ -->
            <div 
              class="item-image"
              :style="getPartsBackgroundStyle(item, item.color)"
            >
              <!-- Áâ©ÂìÅÊï∞ÈáèÊòæÁ§∫ -->
              <div v-if="item.nowNum && item.nowNum > 1" class="item-count">
                {{ formatNumber(item.nowNum) }}
              </div>
              
              <!-- Êñ∞Áâ©ÂìÅÊ†áËØÜ -->
              <div v-if="item.newB" class="new-badge">Êñ∞</div>
              
              <!-- ÈîÅÂÆöÊ†áËØÜ -->
              <div v-if="item.lockB" class="lock-badge">üîí</div>
            </div>
            
            <!-- Áâ©ÂìÅ‰ø°ÊÅØ -->
            <div class="item-info">
              <div class="item-name" :title="item.cnName">
                {{ item.cnName }}
              </div>
              <div class="item-meta">
                <div class="item-level" v-if="item.itemsLevel > 1">
                  Lv.{{ item.itemsLevel }}
                </div>
                <el-tag 
                  :type="getColorTagType(item.color) as any" 
                  size="small"
                  class="item-type-tag"
                >
                  {{ getColorName(item.color) }}
                </el-tag>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ÂàÜÈ°µ -->
        <div class="pagination-section">
          <el-pagination
            v-model:current-page="currentPage"
            v-model:page-size="pageSize"
            :page-sizes="[49]"
            :total="filteredItems.length"
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
          />
        </div>
      </div>
      
      <!-- ËØ¶ÁªÜÊï∞ÊçÆ -->
      <JsonViewer 
        :json-data="jsonData"
        title="ËØ¶ÁªÜÊï∞ÊçÆ"
        collapse-title="Êü•ÁúãÂÆåÊï¥JSONÊï∞ÊçÆ"
        :rows="10"
      />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { computed, ref, watch } from 'vue'
import { useArchiveStore } from '@/stores/archive'
import { Box, Grid, Collection, Search, Refresh, Star } from '@element-plus/icons-vue'
import { getPartsBackgroundStyle } from '@/utils/backgroundImages'

import { PartsBag, PartsItem } from '@/types/archive/module/parts'
import JsonViewer from '@/components/JsonViewer.vue'

const archiveStore = useArchiveStore()

// Ëé∑ÂèñÈõ∂‰ª∂ËÉåÂåÖÊï∞ÊçÆ
const data = computed((): PartsBag | null => {
  return archiveStore.getModuleData('partsBag') as PartsBag | null
})

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchText = ref('')
const selectedColor = ref('')
const selectedType = ref('')
const sortBy = ref('level-desc')
const currentPage = ref(1)
const pageSize = ref(49) // 7Ë°å7Âàó = 49

// ËÆ°ÁÆóÂ±ûÊÄß
const totalItems = computed(() => data.value?.arr?.length || 0)
const gripMaxNum = computed(() => data.value?.gripMaxNum || 0)
const usedSlots = computed(() => {
  if (!data.value?.arr) return 0
  return data.value.arr.filter(item => item.nowNum > 0).length
})

// ËøáÊª§ÂêéÁöÑÁâ©ÂìÅ
const filteredItems = computed(() => {
  if (!data.value?.arr) return []
  
  let items = [...data.value.arr]
  
  // ÊêúÁ¥¢ËøáÊª§
  if (searchText.value) {
    items = items.filter(item => 
      item.cnName.toLowerCase().includes(searchText.value.toLowerCase())
    )
  }
  
  // ÂìÅË¥®ËøáÊª§
  if (selectedColor.value) {
    items = items.filter(item => item.color === selectedColor.value)
  }
  
  // Á±ªÂûãËøáÊª§,ÊôÆÈÄöÈõ∂‰ª∂ÂíåÁã¨ÁâπÁöÑÈõ∂‰ª∂
  if (selectedType.value) {
    if(selectedType.value === "loaderParts"){
      items = items.filter(item => item.name === "loaderParts")
    }
    else{
      items = items.filter(item => item.name !== "loaderParts")
    }
    
  }
  
  // ÊéíÂ∫è
  items = sortItems(items, sortBy.value)
  
  return items
})

// ÂàÜÈ°µÂêéÁöÑÁâ©ÂìÅ
const paginatedItems = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return filteredItems.value.slice(start, end)
})

// JSONÊï∞ÊçÆ
const jsonData = computed(() => {
  return JSON.stringify(data.value, null, 2)
})

// ÊñπÊ≥ï
const handleSearch = () => {
  currentPage.value = 1
}

const handleFilter = () => {
  currentPage.value = 1
}

const resetFilters = () => {
  searchText.value = ''
  selectedColor.value = ''
  selectedType.value = ''
  sortBy.value = 'level-desc'
  currentPage.value = 1
}

const handleSort = () => {
  currentPage.value = 1
}

// ÊéíÂ∫èÂáΩÊï∞
const sortItems = (items: PartsItem[], sortType: string) => {
  const sortedItems = [...items]
  
  switch (sortType) {
    case 'level-desc':
      return sortedItems.sort((a, b) => b.itemsLevel - a.itemsLevel)
    case 'level-asc':
      return sortedItems.sort((a, b) => a.itemsLevel - b.itemsLevel)
    case 'quantity-desc':
      return sortedItems.sort((a, b) => b.nowNum - a.nowNum)
    case 'quantity-asc':
      return sortedItems.sort((a, b) => a.nowNum - b.nowNum)
    case 'color':
      const colorOrder = ['darkgold','black', 'red', 'purple', 'blue', 'green', 'white']
      return sortedItems.sort((a, b) => {
        const aIndex = colorOrder.indexOf(a.color)
        const bIndex = colorOrder.indexOf(b.color)
        return aIndex - bIndex
      })
    case 'type':
      return sortedItems.sort((a, b) => {
        if (a.itemsType !== b.itemsType) {
          return a.itemsType.localeCompare(b.itemsType)
        }
        return b.itemsLevel - a.itemsLevel
      })
    default:
      return sortedItems
  }
}

const handleSizeChange = (val: number) => {
  pageSize.value = val
  currentPage.value = 1
}

const handleCurrentChange = (val: number) => {
  currentPage.value = val
}

/**
 * Ê†ºÂºèÂåñÊï∞Â≠óÊòæÁ§∫
 */
function formatNumber(num: number): string {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M'
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K'
  }
  return num.toString()
}

/**
 * Ëé∑ÂèñÈ¢úËâ≤Ê†áÁ≠æÁ±ªÂûã
 */
function getColorTagType(color: string): string {
  // Á°Æ‰øùcolor‰∏ç‰∏∫Á©∫Êàñundefined
  if (!color) return 'info'
  
  const colorMap: Record<string, string> = {
    'white': 'info',
    'green': 'success',
    'blue': 'primary',
    'purple': 'warning',
    'orange': 'danger',
    'red': 'danger',
    'black': 'info', // Êîπ‰∏∫infoÔºåÂõ†‰∏∫el-tag‰∏çÊîØÊåÅdark
    'darkgold': 'warning',
    'purgold': 'warning',
    'yagold': 'warning'
  }
  return colorMap[color] || 'info'
}

/**
 * Ëé∑ÂèñÈ¢úËâ≤ÂêçÁß∞
 */
function getColorName(color: string): string {
  // Á°Æ‰øùcolor‰∏ç‰∏∫Á©∫Êàñundefined
  if (!color) return 'Êú™Áü•'
  
  const colorMap: Record<string, string> = {
    'white': 'ÁôΩËâ≤',
    'green': 'ÁªøËâ≤',
    'blue': 'ËìùËâ≤',
    'purple': 'Á¥´Ëâ≤',
    'orange': 'Ê©ôËâ≤',
    'red': 'Á∫¢Ëâ≤',
    'black': 'ÈªëËâ≤',
    'darkgold': 'ÊöóÈáë',
    'purgold': 'Á¥´Èáë',
    'yagold': 'ÈõÖÈáë'
  }
  return colorMap[color] || color
}


// ÁõëÂê¨Êï∞ÊçÆÂèòÂåñÔºåÈáçÁΩÆÂàÜÈ°µ
watch(() => data.value, () => {
  currentPage.value = 1
})
</script>

<style scoped>
.parts-bag-module {
  padding: 20px;
  background: #f5f5f5;
  min-height: 100vh;
}

.module-card {
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-icon {
  font-size: 24px;
  color: #409eff;
}

.card-header h2 {
  margin: 0;
  color: #303133;
  font-size: 20px;
}

.module-desc {
  margin: 4px 0 0 0;
  color: #909399;
  font-size: 14px;
}

.bag-stats {
  margin-bottom: 24px;
}

.stat-card {
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.stat-icon {
  font-size: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #f5f7fa;
}

.stat-info {
  flex: 1;
}

.stat-label {
  font-size: 14px;
  color: #909399;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 18px;
  font-weight: 600;
  color: #303133;
}

.text-primary {
  color: #409eff !important;
}

.text-success {
  color: #67c23a !important;
}

.text-warning {
  color: #e6a23c !important;
}

.text-danger {
  color: #f56c6c !important;
}

.text-info {
  color: #909399 !important;
}

.items-section {
  margin-top: 24px;
}

.filter-section {
  margin-bottom: 20px;
}

.mb-20 {
  margin-bottom: 20px;
}

.items-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  padding: 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 24px;
}

.item-slot {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  background: #fafafa;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
}

.item-slot:hover {
  border-color: #409eff;
  box-shadow: 0 4px 8px rgba(64, 158, 255, 0.2);
  transform: translateY(-2px);
}

.item-slot.new-item {
  border-color: #67c23a;
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
}

.item-slot.locked {
  opacity: 0.6;
  border-color: #f56c6c;
}

.item-image {
  width: 56px;
  height: 56px;
  position: relative;
  margin-bottom: 8px;
  border-radius: 4px;
  overflow: hidden;
}

.item-count {
  position: absolute;
  bottom: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  font-size: 10px;
  padding: 1px 4px;
  border-radius: 3px;
  font-weight: bold;
  min-width: 16px;
  text-align: center;
}

.new-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: #67c23a;
  color: white;
  font-size: 8px;
  padding: 1px 4px;
  border-radius: 3px;
  font-weight: bold;
}

.lock-badge {
  position: absolute;
  top: -2px;
  left: -2px;
  font-size: 12px;
}

.item-info {
  text-align: center;
  width: 100%;
}

.item-name {
  font-size: 12px;
  color: #333;
  font-weight: 500;
  line-height: 1.2;
  margin-bottom: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100px;
}

.item-meta {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: center;
}

.item-level {
  font-size: 10px;
  color: #666;
  background: #f0f0f0;
  padding: 1px 4px;
  border-radius: 3px;
  display: inline-block;
}

.item-type-tag {
  font-size: 9px;
  height: 18px;
  line-height: 16px;
}

.pagination-section {
  display: flex;
  justify-content: center;
  margin-top: 24px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .items-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    padding: 10px;
  }
  
  .item-slot {
    padding: 8px;
  }
  
  .item-image {
    width: 48px;
    height: 48px;
  }
  
  .item-name {
    font-size: 11px;
    max-width: 80px;
  }
}

@media (max-width: 480px) {
  .items-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 6px;
    padding: 8px;
  }
  
  .item-slot {
    padding: 6px;
  }
  
  .item-image {
    width: 40px;
    height: 40px;
  }
  
  .item-name {
    font-size: 10px;
    max-width: 60px;
  }
}
</style>
